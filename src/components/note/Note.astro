---
import { type CollectionEntry, render } from "astro:content";
import FormattedDate from "@/components/FormattedDate.astro";
import type { HTMLTag, Polymorphic } from "astro/types";
import LazyImage from "@/components/LazyImage.astro";

type Props<Tag extends HTMLTag> = Polymorphic<{ as: Tag }> & {
	note: CollectionEntry<"note">;
	isPreview?: boolean | undefined;
};

const { as: Tag = "div", note, isPreview = false } = Astro.props;
const { Content } = await render(note);
// Optional cover image from frontmatter: note.data.image
// Cast to any to avoid schema strictness if image isn't declared in the collection
const coverImage = (note.data as any)?.image as string | undefined;
---

<article
	class:list={[isPreview && "inline-grid w-full rounded-lg bg-color-75 px-4 md:px-8 py-2 md:py-4"]}
	data-pagefind-body={isPreview ? false : true}
>
	<Tag class="flex items-end title md:top-8 md:z-10" class:list={{ "text-base": isPreview }}>
		{
			isPreview ? (
				<a class="citrus-link" href={`/notes/${note.id}/`}>
					{note.data.title}
				</a>
			) : (
				<>{note.data.title}</>
			)
		}
	</Tag>
	<div 
		class="flex items-end h-6 text-sm text-lighter"
		class:list={{ "mt-4": !isPreview }}
	>
		
		<FormattedDate
			dateTimeOptions={{
				hour: "2-digit",
				minute: "2-digit",
				year: "numeric",
				month: "long",
				day: "2-digit",
			}}
			date={note.data.publishDate}
		/>
	</div>

	{isPreview && coverImage && (
		<div class="mt-3 w-full overflow-hidden rounded-lg">
			<LazyImage 
				src={coverImage} 
				alt={note.data.title} 
				class="block h-60 w-full object-cover rounded-lg" 
				loading="lazy"
				height={240}
				width={400}
				aspectRatio="5/3"
				rounded={true}
				skeletonClass="rounded-lg"
			/>
		</div>
	)}
	<div
		class="prose prose-citrus prose-img:rounded-2xl mt-4 max-w-none [&>p:last-of-type]:mb-0"
		class:list={{
			// Keep preview short and tidy
			"max-h-48 md:max-h-56 overflow-hidden relative": isPreview,
			// Allow first two blocks to render so a following blockquote shows up
			"[&>*:nth-child(n+3)]:hidden": isPreview,
			// Hide ALL images in preview mode when we have a cover image
			"[&_img]:!hidden": isPreview && coverImage,
			// Hide other elements in preview mode
			"[&>pre]:hidden [&>figure]:hidden [&>table]:hidden [&>iframe]:hidden [&>video]:hidden": isPreview,
			"[&>ul]:hidden [&>ol]:hidden": isPreview,
			// Clamp the first two text blocks if they are long
			"[&>p:nth-child(-n+2)]:line-clamp-4 [&>blockquote:nth-child(-n+2)]:line-clamp-4": isPreview,
		}} 
	>
		<Content />
	</div>
</article>
